<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="icon" type="image/svg+xml" href="../assets/img_logos/motorcycle.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style src="style.css"></style>
</head>
<body class="bg-gray-100 p-6 min-h-screen relative">
    <video autoplay muted loop playsinline class="fixed top-0 left-0 w-full h-full object-cover -z-10">
        <source src="../assets/vids/hero2.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="container mx-auto p-6 max-w-7xl">
        <div class="bg-white/90 backdrop-blur-sm shadow-2xl rounded-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-gray-600 to-gray-800 p-6">
                <h1 class="text-3xl font-bold text-white">Checkout</h1>
            </div>

            <div class="p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column - Cart Items -->
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-xl p-6 shadow-sm">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Summary</h2>
                            <div id="checkout-items" class="space-y-4"></div>
                            <div class="border-t-2 border-gray-300 mt-6 pt-4">
                                <div class="flex justify-between items-center text-2xl font-bold text-gray-900">
                                    <span>Total:</span>
                                    <span id="total-price">‚Ç±0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Shipping Form -->
                        <div class="bg-gray-50 rounded-xl p-6 shadow-sm">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Shipping Address</h2>
                            <form id="shipping-form" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2" for="name">Full Name</label>
                                    <input id="name" name="name" placeholder="Juan Dela Cruz" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" type="text" required>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2" for="address">Address</label>
                                    <textarea id="address" name="address" placeholder="House/Building No., Street Name" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" rows="3" required></textarea>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2" for="phone">Phone Number</label>
                                    <input id="phone" name="phone" placeholder="Please enter a valid phone number" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" type="tel" pattern="[0-9]{10,11}" required>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2" for="city">City</label>
                                        <input id="city" name="city" placeholder="Manila" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" type="text" required>
                                    </div>

                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2" for="state">State/Province</label>
                                        <input id="state" name="state" placeholder="Metro Manila" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" type="text" required>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2" for="zip">ZIP Code</label>
                                        <input id="zip" name="zip" placeholder="1000" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" type="text" required>
                                    </div>

                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2" for="country">Country</label>
                                        <select id="country" name="country" class="w-full bg-white rounded-lg border border-gray-300 text-gray-900 px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" required>
                                            <option value="">Select a country</option>
                                            <option value="PH" selected>Philippines</option>
                                            <option value="US">United States</option>
                                            <option value="JP">Japan</option>
                                            <option value="SG">Singapore</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Payment Method -->
                        <div class="bg-gray-50 rounded-xl p-6 shadow-sm">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Payment Method</h2>
                            <div class="space-y-3" id="payment-options">
                                <!-- GCash (Disabled) -->
                                <div class="relative group">
                                    <label class="flex justify-between items-center rounded-lg p-4 border-2 border-gray-200 bg-gray-100 cursor-not-allowed opacity-60">
                                        <div class="flex items-center gap-3">
                                            <svg fill="currentColor" viewBox="0 0 24 24" height="28" width="28" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                            </svg>
                                            <div>
                                                <span class="font-semibold text-gray-800">GCash</span>
                                            </div>
                                        </div>
                                        <input class="w-5 h-5 text-indigo-600 focus:ring-2 focus:ring-indigo-500" value="gcash" name="payment" type="radio" disabled>
                                    </label>
                                    <div class="absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-sm rounded-lg whitespace-nowrap transition-all duration-200 pointer-events-none">
                                        Currently not available
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>

                                <!-- Credit/Debit Card (Disabled) -->
                                <div class="relative group">
                                    <label class="flex justify-between items-center rounded-lg p-4 border-2 border-gray-200 bg-gray-100 cursor-not-allowed opacity-60">
                                        <div class="flex items-center gap-3">
                                            <svg fill="currentColor" viewBox="0 0 576 512" height="28" width="28" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M512 80c8.8 0 16 7.2 16 16v32H48V96c0-8.8 7.2-16 16-16H512zm16 144V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V224H528zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm56 304c-13.3 0-24 10.7-24 24s10.7 24 24 24h48c13.3 0 24-10.7 24-24s-10.7-24-24-24H120zm128 0c-13.3 0-24 10.7-24 24s10.7 24 24 24H360c13.3 0 24-10.7 24-24s-10.7-24-24-24H248z"/>
                                            </svg>
                                            <div>
                                                <span class="font-semibold text-gray-800">Credit/Debit Card</span>
                                                <p class="text-xs text-gray-500">Visa, Mastercard, JCB</p>
                                            </div>
                                        </div>
                                        <input class="w-5 h-5 text-indigo-600 focus:ring-2 focus:ring-indigo-500" value="card" name="payment" type="radio" disabled>
                                    </label>
                                    <div class="absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-sm rounded-lg whitespace-nowrap transition-all duration-200 pointer-events-none">
                                        Currently not available
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>

                                <!-- Cash on Delivery -->
                                <label class="flex justify-between items-center rounded-lg p-4 border-2 border-gray-200 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 hover:bg-gray-100 transition-all cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <svg fill="currentColor" height="28" width="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                        </svg>
                                        <span class="font-semibold text-gray-800">Cash on Delivery</span>
                                    </div>
                                    <input class="w-5 h-5 text-indigo-600 focus:ring-2 focus:ring-indigo-500" value="cod" name="payment" type="radio" required>
                                </label>

                                <!-- Cash on Pickup-->
                                <label class="flex justify-between items-center rounded-lg p-4 border-2 border-gray-200 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 hover:bg-gray-100 transition-all cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <svg fill="currentColor" viewBox="0 0 24 24" height="28" width="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
                                        </svg>
                                        <span class="font-semibold text-gray-800">Cash on Pickup</span>
                                    </div>
                                    <input class="w-5 h-5 text-indigo-600 focus:ring-2 focus:ring-indigo-500" value="cop" name="payment" type="radio" required>
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button id="submit-btn" type="button" class="w-full bg-gradient-to-r from-gray-600 to-gray-800 text-white font-bold py-4 px-6 rounded-xl hover:from-red-500 hover:to-red-600 transform hover:scale-105 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            Submit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        emailjs.init("kr4qu3TfwBUke4sRc");
        const SUPABASE_URL = 'https://wqlxqsuxzydsnvrifksu.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxbHhxc3V4enlkc252cmlma3N1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTYwNjgsImV4cCI6MjA2MTMzMjA2OH0.xLCjspi1YMi01wMfgDx2QIN7aM19tq4Vk-txskxNVH0'
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const checkoutContainer = document.getElementById("checkout-items");
        const totalPriceElement = document.getElementById("total-price");
        const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
        let formSubmitted = false;

        function calculateTotal() {
            return cartItems.reduce((total, item) => {
                const price = parseFloat(item.price.replace(/[‚Ç±,]/g, ''));
                return total + (price * item.quantity);
            }, 0);
        }

        function displayCartItems() {
            if (cartItems.length === 0) {
                checkoutContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Your cart is empty.</p>';
                totalPriceElement.textContent = '‚Ç±0.00';
            } else {
                checkoutContainer.innerHTML = cartItems.map((item, index) => {
                    const price = parseFloat(item.price.replace(/[‚Ç±,]/g, ''));
                    const itemTotal = price * item.quantity;
                    
                    return `
                        <div class="flex justify-between items-center p-4 bg-white rounded-lg border border-gray-200">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${item.name}</p>
                                    <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
                                </div>
                            </div>
                            <div class="text-right mr-4">
                                <p class="font-bold text-indigo-600">${item.price}</p>
                                <p class="text-sm text-gray-600">Total: ‚Ç±${itemTotal.toFixed(2)}</p>
                            </div>
                            <button class="remove-item text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-colors" data-index="${index}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                }).join('');
                
                document.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFromCartInCheckout(index);
                    });
                });
                
                const total = calculateTotal();
                totalPriceElement.textContent = `‚Ç±${total.toFixed(2)}`;
            }
        }

        function removeFromCartInCheckout(index) {
            if (index >= 0 && index < cartItems.length) {
                cartItems.splice(index, 1);
                localStorage.setItem("cartItems", JSON.stringify(cartItems));
                displayCartItems();
                
                alert('Item removed from cart');
            }
        }

        // Verify stock availability before placing order
        async function verifyStockAvailability() {
            try {
                for (const item of cartItems) {
                    const { data: product, error } = await supabaseClient
                        .from('product')
                        .select('stock, name')
                        .eq('name', item.name)
                        .single();

                    if (error) throw error;

                    if (product.stock < item.quantity) {
                        return {
                            available: false,
                            message: `Sorry, "${item.name}" has insufficient stock. Available: ${product.stock}, Requested: ${item.quantity}`
                        };
                    }
                }
                return { available: true };
            } catch (error) {
                console.error('Error verifying stock:', error);
                return {
                    available: false,
                    message: 'Error verifying stock availability. Please try again.'
                };
            }
        }

        // Update stock after order confirmation
        async function updateProductStock() {
            try {
                console.log('Starting stock update for items:', cartItems);
                
                for (const item of cartItems) {
                    console.log('Processing item:', item.name);
                    
                    // Get current stock
                    const { data: product, error: fetchError } = await supabaseClient
                        .from('product')
                        .select('stock, name')
                        .eq('name', item.name)
                        .single();

                    console.log('Current product data:', product, 'Error:', fetchError);

                    if (fetchError) {
                        console.error('Error fetching product:', fetchError);
                        throw fetchError;
                    }

                    // Calculate new stock
                    const newStock = product.stock - item.quantity;
                    console.log(`Updating ${item.name}: ${product.stock} - ${item.quantity} = ${newStock}`);

                    // Update stock
                    const { data: updateData, error: updateError } = await supabaseClient
                        .from('product')
                        .update({ stock: newStock })
                        .eq('name', item.name)
                        .select();

                    console.log('Update result:', updateData, 'Error:', updateError);

                    if (updateError) {
                        console.error('Error updating stock:', updateError);
                        throw updateError;
                    }
                    
                    console.log(`Successfully updated stock for ${item.name}`);
                }
                return { success: true };
            } catch (error) {
                console.error('Error updating stock:', error);
                return { success: false, error };
            }
        }

        displayCartItems();

        const submitBtn = document.getElementById('submit-btn');
        const shippingForm = document.getElementById('shipping-form');

        submitBtn.addEventListener('click', async () => {
            if (!formSubmitted) {
                if (!shippingForm.checkValidity()) {
                    shippingForm.reportValidity();
                    return;
                }

                const paymentMethod = document.querySelector('input[name="payment"]:checked');
                if (!paymentMethod) {
                    alert('Please select a payment method');
                    return;
                }

                submitBtn.textContent = 'Order Now';
                formSubmitted = true;
            } else {
                // Check if cart is empty
                if (cartItems.length === 0) {
                    alert('Your cart is empty. Please add items before placing an order.');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Verifying stock...';

                try {
                    // Step 1: Verify stock availability
                    const stockCheck = await verifyStockAvailability();
                    if (!stockCheck.available) {
                        alert(stockCheck.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Order Now';
                        return;
                    }

                    submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Processing order...';

                    const formData = new FormData(shippingForm);
                    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                    
                    const orderData = {
                        customer_name: formData.get('name'),
                        address: formData.get('address'),
                        phone_number: formData.get('phone'),
                        city: formData.get('city'),
                        state: formData.get('state'),
                        zip_code: formData.get('zip'),
                        country: formData.get('country'),
                        payment_method: paymentMethod,
                        items: cartItems,
                        total_amount: calculateTotal(),
                        order_date: new Date().toLocaleString(),
                        order_status: 'pending', // Default status
                        stock_reduced: false // Flag to track if stock was reduced
                    };

                    // Step 2: Insert order into database
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .insert([orderData])
                        .select();

                    if (error) throw error;

                    submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Updating inventory...';

                    // Step 3: Update stock immediately (will be reversed if order is marked as fraudulent)
                    const stockUpdate = await updateProductStock();
                    if (!stockUpdate.success) {
                        throw new Error('Failed to update stock');
                    }

                    // Step 4: Mark order as stock_reduced
                    await supabaseClient
                        .from('orders')
                        .update({ stock_reduced: true })
                        .eq('id', data[0].id);

                    submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Sending confirmation...';

                    // Step 5: Send email notification
                    const itemsList = orderData.items.map(item => 
                        `‚Ä¢ ${item.name} (Qty: ${item.quantity}) - ${item.price}`
                    ).join('\n'); 

                    const emailParams = {
                        business_email: '2ndstreet.motoshop@gmail.com', 
                        order_id: data[0].id,
                        customer_name: orderData.customer_name,
                        customer_phone: orderData.phone_number,
                        order_date: orderData.order_date,
                        total_amount: `‚Ç±${orderData.total_amount.toFixed(2)}`,
                        payment_method: orderData.payment_method === 'cod' ? 'Cash on Delivery' : 'Cash on Pickup',
                        shipping_address: `${orderData.address}, ${orderData.city}, ${orderData.state} ${orderData.zip_code}, ${orderData.country}`,
                        items_list: itemsList,
                        item_count: orderData.items.reduce((total, item) => total + item.quantity, 0)
                    };

                    try {
                        await emailjs.send('service_d21ukdh', 'template_nfz28po', emailParams);
                        console.log('Business notification sent successfully');
                    } catch (emailError) {
                        console.log('Email notification failed, but order was saved:', emailError);
                    }

                    // Step 6: Clear cart and redirect
                    localStorage.removeItem('cartItems');
                    alert(`Order placed successfully! üéâ\n\nOrder ID: ${data[0].id}\n\nYour order is pending verification. Stock has been reserved. We will contact you soon to confirm your order.`);
                    window.location.href = 'products.html';
                    
                } catch (error) {
                    console.error('Error placing order:', error);
                    alert('Failed to place order. Please try again. Error: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Order Now';
                }
            }
        });

        document.querySelectorAll('input[name="payment"][disabled]').forEach(input => {
            input.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        document.querySelectorAll('#payment-options .cursor-not-allowed').forEach(label => {
            label.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
    </script>
</body>
</html>